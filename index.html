<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Сериалы ТОП-250</title>
    
    <!-- PWA мета-теги -->
    <meta name="theme-color" content="#0B0F14">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Сериалы ТОП-250">
    
    <!-- Манифест PWA -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogItCh0LXRgNC40LDQu9GLINCi0J7Qny0yNTAiLAogICJzaG9ydF9uYW1lIjogItCh0LXRgNC40LDQu9GLIiwKICAiZGVzY3JpcHRpb24iOiAi0JLQuNC60YLQvtGA0LjQvdCwINC/0L4g0LvRg9GH0YjQuNC8INGB0LXRgNC40LDQu9Cw0Lwg0JrQuNC90L7Qn9C+0LjRgdC60LAiLAogICJzdGFydF91cmwiOiAiLiIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiIzBCMEYxNCIsCiAgInRoZW1lX2NvbG9yIjogIiMwQjBGMTQiLAogICJvcmllbnRhdGlvbiI6ICJwb3J0cmFpdCIsCiAgImljb25zIjogWwogICAgeyAic3JjIjogImRhdGE6aW1hZ2Uvc3ZnK3htbDtiYXNlNjQsUEhOMlp5QjNhV1IwYUQwaU1USTRJaUJvWldsbmFIUTlJakV5T0NJZ2RtbGxkMEp2ZUQwaU1DQXdJREV5T0NBeU9DSWdabWxzYkQwaUl6QkNNRVl4TkNJZ2VHMXNibk05SW1oMGRIQTZMeTkzZDNjdWR6TXViM0puTHpJd01EQXZjM1puSWo0OGNtVmpkQ0IzYVdSMGFEMGlNVEk0SWlCb1pXbG5hSFE5SWpFeU9DSWdabWxzYkQwaUkwWkdORVEwUkNJdkBqOGRHVjRkQ0IzYVdSMGFEMGlNVEk0SWlCb1pXbG5hSFE5SWpFeU9DSWdkbUZzYVdkdVBTSnRhV1JrYkdVaUlHWnBiR3c5SWlObVptWm1abVlpSUdadmJuUXRjMmw2WlQwaU5EaHdlQ0krUUVwRlRreDBiMmd0TlNJOEwzUmxlSFErUEM5emRtYytJaXdnSW5SNWNHVWlPaUFpYVcxaFoyVXZjM1puSzNodGJDSXNJQ0p6YVhwbGN5STZMQ0E0SWl3Z01USTRJaXdnTWpVMklpd2dOVEV5ZlYwc0NpQWlhV052Ym5OZlptOU55R0ZrWkdWeVgyRndjQ0k2SUZ0N0lpSnpjbU1pT2lBaVpHRjBZVHBwYldGblpTOXdibWM3WW1GelpUWTBMa2xXUWs5eVJ6QXNSRUJ5UVU5VGNGaEJlVVF3T0VselpIcGFNeTl3UVVSblJrRkdjbnAwUjBOSWRucG9UMk5mYkU0eWVUSm9kbUp4ZGxOblJXNWZaR1pqVlVaUlRFOWFiV3hzUmtoUGQydHdOSE00VGxKNGIzVnZYMVpOTXpkaGJXWkJWa2MzVFVGSU5USXRNM3BVTTFOaVZWTXZVVVE1U1VwUlpXOVRWRU5rVVV0amJUQlVTbFZzUlZOb1dYQTNhV3RuTW5Sb1RUVnZVa3RHZERGYVpVOWpUMWRZYVZwU1NHdDFWRTh2Y3preGNXRlVZazVzVUhsUlZYaHliV3BrZEdKdllqQXJkMDFmVm1oSFNXbFZOVzU1TWxoNFRHTnNZMWxaYVc5bGRHeDJWU0lzSUNKemRHRnlkRjkxY213aU9pQWlMaUlzSUNKa2FYTndiR0Y1SWpvZ0luTjBZVzVrWVd4dmJtVWlMQ0FpZEhsd1pTSTZJQ0pwYldGblpTOXdibWNpZlMxZDdDaUFpY21GdVoyVmZhVzVmWW1GemJ6WWlPaUJ3YlRVMUwydExka051UkVkaE1XRnNWR2RJY0hjN1Y0MFRBZ3JLWjROR28vdWc4enFIUTVKS2EwN3FJQnRKSGtNdjYrMlFRaVc4dmJRU25kVG0rR3Q4QVZ1SHhUUVBSaW8zLzVZQ2pjckxEenU1ckMrakc1cVV3PT0iLAogICAgImNoQ0F1cm4wNllGdTZXdUdHc0VxMjNlUzFVb1Y5aWJJc1h5L1FpbkdNb1FrWlYzdG14anErc2JaYjZIaWFuQXB5ZHhZWldVeXY5cGRLNDZHK29OOFFPRVJyNk16NWNrZ3JRM1NGMit0MlkwV0tKQ0pHd0FBQUFBQVNVVk9SSzVDWUlJPSIsICJ0eXBlIjogImltYWdlL3BuZyIsICJzaXplcyI6ICIxOTJ4MTkyIn0sCiAgICB7ICJzcmMiOiAiZGF0YTppbWFnZS9wbmc7YmFzZTY0LGlWQk9SdzBLR2dvQUFBQU5TVWhFVWdBQUFIZ0FBQUI0Q0FZQUFBQ+f+7sTGUUFBTGlJaWNIZGxVSjFHZUVFVHFNcjNWS+Y3s2ZBanJuTjdpQTdYaWhtOE9mZHYrV1dSVjV0cWo+c2FCT0lJZDU4a1VnMi9YNkhDdHN6T1h5ak9sUUdPRkx4SjlSQklZTWZKbGlFZktxU1hvUGE+YVorZ2VIVzJzQlJKSEVGTGFGa09rY2o2eFhhTFNreUh1dHBJZ2hBQ2hMUWRzR0lWZXdjQ0d1Sk9oMXRGMk9RRUhJbUQrZWErQmlnS0FGRFQ+KuAzWStSVGUvMjE4SERZelVzWmdYUXkyQ20vWnMwT3lsWWgrczV5N2hGWEswYUtVUFF3eFEyRzk5c0ZaRkkrSW9xU2txdVVJZWFJQ+BWJPWktoS0xtKy5ZcmcjY9PSIsICJ0eXBlIjogImltYWdlL3BuZyIsICJzaXplcyI6ICIxOTJ4MTkyIn0KICBdLAogICJjYXRlZ29yaWVzIjogWyJnYW1lcyIsICJlbnRlcnRhaW5tZW50Il0KfQ==">
    
    <!-- Иконки для разных платформ -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTI4IiBoZWlnaHQ9IjEyOCIgdmlld0JveD0iMCAwIDEyOCAyOCIgZmlsbD0iIzBCMEYxNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTI4IiBoZWlnaHQ9IjEyOCIgZmlsbD0iI0ZGNEQ0RCIvPjx0ZXh0IHdpZHRoPSIxMjgiIGhlaWdodD0iMTI4IiB2YWxpZ249Im1pZGRsZSIgZmlsbD0iI2ZmZmZmZiIgZm9udC1zaXplPSI0OHB4Ij5AQUE8L3RleHQ+PC9zdmc+">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #0B0F14 0%, #1F2937 50%, #0B0F14 100%);
            color: #E2E8F0;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .screen {
            display: none;
        }
        
        .screen.active {
            display: block;
        }
        
        .card {
            background: rgba(31, 41, 55, 0.5);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 32px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .btn {
            padding: 20px 32px;
            border: none;
            border-radius: 16px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            min-height: 60px;
            touch-action: manipulation;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        }
        
        .btn-primary {
            background: linear-gradient(45deg, #FF4D4D, #FF6B6B);
            color: white;
        }
        
        .btn-secondary {
            background: linear-gradient(45deg, #7FB2FF, #60A5FA);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(45deg, #10B981, #34D399);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(45deg, #F59E0B, #FBBF24);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(45deg, #EF4444, #F87171);
            color: white;
        }
        
        .btn-gray {
            background: linear-gradient(45deg, #6B7280, #9CA3AF);
            color: white;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .title {
            font-size: 64px;
            font-weight: 700;
            background: linear-gradient(45deg, #FF4D4D, #7FB2FF);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .subtitle {
            font-size: 24px;
            color: #9CA3AF;
            text-align: center;
            margin-bottom: 40px;
        }
        
        .grid {
            display: grid;
            gap: 20px;
        }
        
        .grid-2 {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        }
        
        .grid-4 {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }
        
        .game-header {
            background: rgba(31, 41, 55, 0.7);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .stat {
            text-align: center;
        }
        
        .stat-label {
            font-size: 14px;
            color: #9CA3AF;
            margin-bottom: 4px;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: 700;
        }
        
        .progress-bar {
            background: #374151;
            border-radius: 8px;
            height: 8px;
            margin-top: 16px;
            overflow: hidden;
        }
        
        .progress-fill {
            background: linear-gradient(45deg, #7FB2FF, #A855F7);
            height: 100%;
            transition: width 0.3s ease;
        }
        
        .question-card {
            background: rgba(31, 41, 55, 0.5);
            border-radius: 16px;
            padding: 32px;
            text-align: center;
        }
        
        .question-text {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 32px;
            line-height: 1.4;
        }
        
        .answer-btn {
            width: 100%;
            padding: 20px;
            margin: 8px 0;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 500;
            cursor: pointer;
            background: rgba(55, 65, 81, 0.7);
            color: white;
            text-align: left;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }
        
        .answer-btn:hover {
            background: rgba(75, 85, 99, 0.8);
            transform: translateY(-2px);
        }
        
        .answer-btn.correct {
            background: linear-gradient(45deg, #10B981, #34D399);
            animation: correctPulse 0.6s ease-out;
        }
        
        .answer-btn.incorrect {
            background: linear-gradient(45deg, #EF4444, #F87171);
            animation: incorrectShake 0.6s ease-out;
        }
        
        .answer-btn.hidden {
            background: rgba(55, 65, 81, 0.3);
            color: #6B7280;
            cursor: not-allowed;
        }
        
        @keyframes correctPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        @keyframes incorrectShake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        
        .timer {
            font-size: 32px;
            font-weight: 700;
            color: #FF4D4D;
        }
        
        .timer.warning {
            animation: timerPulse 1s infinite;
        }
        
        @keyframes timerPulse {
            0%, 100% { color: #FF4D4D; }
            50% { color: #FCA5A5; }
        }
        
        .hints {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .hint-btn {
            padding: 12px 20px;
            font-size: 14px;
            border-radius: 8px;
        }
        
        .fact-box {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0;
        }
        
        .fact-label {
            font-size: 14px;
            color: #93C5FD;
            margin-bottom: 8px;
        }
        
        .fact-text {
            color: #DBEAFE;
        }
        
        .text-center {
            text-align: center;
        }
        
        .mb-4 {
            margin-bottom: 16px;
        }
        
        .mb-8 {
            margin-bottom: 32px;
        }
        
        .space-y-4 > * + * {
            margin-top: 16px;
        }
        
        .space-y-8 > * + * {
            margin-top: 32px;
        }
        
        .input, .textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #374151;
            border-radius: 8px;
            background: #374151;
            color: white;
            font-size: 16px;
        }
        
        .textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .editor-form {
            background: rgba(55, 65, 81, 0.5);
            border-radius: 12px;
            padding: 24px;
        }
        
        .question-list {
            max-height: 400px;
            overflow-y: auto;
            border-radius: 8px;
        }
        
        .question-item {
            background: rgba(55, 65, 81, 0.5);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
        }
        
        .leaderboard-item {
            background: rgba(55, 65, 81, 0.5);
            border-radius: 12px;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .leaderboard-item.gold {
            background: linear-gradient(45deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.2));
            border: 1px solid rgba(251, 191, 36, 0.3);
        }
        
        .leaderboard-item.silver {
            background: linear-gradient(45deg, rgba(156, 163, 175, 0.2), rgba(107, 114, 128, 0.2));
            border: 1px solid rgba(156, 163, 175, 0.3);
        }
        
        .leaderboard-item.bronze {
            background: linear-gradient(45deg, rgba(251, 146, 60, 0.2), rgba(249, 115, 22, 0.2));
            border: 1px solid rgba(251, 146, 60, 0.3);
        }
        
        .slide-in {
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @media (max-width: 768px) {
            .title {
                font-size: 48px;
            }
            
            .question-text {
                font-size: 24px;
            }
            
            .game-header {
                flex-direction: column;
                text-align: center;
            }
            
            .hints {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Экран приветствия -->
        <div id="welcome-screen" class="screen active">
            <div class="container">
                <div class="text-center slide-in" style="min-height: 100vh; display: flex; flex-direction: column; justify-content: center;">
                    <h1 class="title">СЕРИАЛЫ ТОП-250</h1>
                    <p class="subtitle">Викторина по лучшим сериалам КиноПоиска</p>
                    
                    <div class="space-y-4" style="max-width: 400px; margin: 0 auto;">
                        <button class="btn btn-primary" style="width: 100%;" onclick="startGame('single')">
                            🎮 ИГРАТЬ
                        </button>
                        <button class="btn btn-secondary" style="width: 100%;" onclick="startGame('party')">
                            🎉 PARTY РЕЖИМ
                        </button>
                        <button class="btn" style="width: 100%; background: linear-gradient(45deg, #A855F7, #8B5CF6);" onclick="showScreen('editor')">
                            ✏️ РЕДАКТОР
                        </button>
                        <button class="btn btn-gray" style="width: 100%;" onclick="showScreen('rules')">
                            📋 ПРАВИЛА
                        </button>
                        <button class="btn btn-warning" style="width: 100%;" onclick="showScreen('leaderboard')">
                            🏆 ЛИДЕРЫ
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Экран правил -->
        <div id="rules-screen" class="screen">
            <div class="container">
                <button class="btn btn-gray mb-8" onclick="showScreen('welcome')">← Назад</button>
                
                <div class="card">
                    <h2 class="text-center mb-8" style="font-size: 48px; font-weight: 700;">📋 Правила игры</h2>
                    
                    <div class="grid grid-2">
                        <div class="space-y-4">
                            <h3 style="font-size: 24px; font-weight: 600; color: #FF6B6B;">🎯 Геймплей</h3>
                            <ul style="color: #D1D5DB; line-height: 1.8;">
                                <li>• 5 раундов по 10 вопросов</li>
                                <li>• Сложность растёт с каждым раундом</li>
                                <li>• Таймер: 20→18→16→14→12 секунд</li>
                                <li>• Только один правильный ответ</li>
                            </ul>
                        </div>
                        
                        <div class="space-y-4">
                            <h3 style="font-size: 24px; font-weight: 600; color: #60A5FA;">💎 Очки</h3>
                            <ul style="color: #D1D5DB; line-height: 1.8;">
                                <li>• Базовые: 100 очков</li>
                                <li>• Множитель раунда: x1.0→x2.5</li>
                                <li>• Бонус за скорость: до x2.0</li>
                                <li>• Штраф за подсказки: -20%</li>
                            </ul>
                        </div>
                        
                        <div class="space-y-4">
                            <h3 style="font-size: 24px; font-weight: 600; color: #A855F7;">💡 Подсказки</h3>
                            <ul style="color: #D1D5DB; line-height: 1.8;">
                                <li>• 50/50: убирает 2 неправильных</li>
                                <li>• +5 сек: добавляет время</li>
                                <li>• Факт: интересная информация</li>
                                <li>• Лимит: 3 использования каждой</li>
                            </ul>
                        </div>
                        
                        <div class="space-y-4">
                            <h3 style="font-size: 24px; font-weight: 600; color: #34D399;">🎉 Режимы</h3>
                            <ul style="color: #D1D5DB; line-height: 1.8;">
                                <li>• Одиночный: играете сами</li>
                                <li>• Party: игроки по очереди</li>
                                <li>• Результаты сохраняются</li>
                                <li>• Таблица лидеров</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Игровой экран -->
        <div id="game-screen" class="screen">
            <div class="container">
                <!-- Шапка игры -->
                <div class="game-header">
                    <h1 style="font-size: 24px; font-weight: 700;">СЕРИАЛЫ ТОП-250</h1>
                    <button class="btn btn-gray" onclick="showScreen('welcome')" style="padding: 8px 16px; font-size: 14px;">← Выход</button>
                </div>
                
                <!-- Статистика -->
                <div class="card mb-4">
                    <div class="grid grid-4 mb-4">
                        <div class="stat">
                            <div class="stat-label">Раунд</div>
                            <div class="stat-value" style="color: #60A5FA;" id="round-display">1/5</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">Вопрос</div>
                            <div class="stat-value" style="color: #34D399;" id="question-display">1/10</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">Очки</div>
                            <div class="stat-value" style="color: #FBBF24;" id="score-display">0</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">Время</div>
                            <div class="stat-value timer" id="timer-display">20с</div>
                        </div>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill" style="width: 2%;"></div>
                    </div>
                </div>

                <!-- Подсказки -->
                <div class="hints">
                    <button class="btn hint-btn" style="background: #A855F7;" onclick="useHint('fiftyFifty')" id="hint-fifty">
                        50/50 (<span id="fifty-count">3</span>)
                    </button>
                    <button class="btn hint-btn" style="background: #10B981;" onclick="useHint('extraTime')" id="hint-time">
                        +5 сек (<span id="time-count">3</span>)
                    </button>
                    <button class="btn hint-btn" style="background: #F59E0B;" onclick="useHint('fact')" id="hint-fact">
                        Факт (<span id="fact-count">3</span>)
                    </button>
                </div>

                <!-- Вопрос -->
                <div class="question-card">
                    <h2 class="question-text" id="question-text">Загрузка вопроса...</h2>
                    
                    <div id="fact-box" class="fact-box" style="display: none;">
                        <div class="fact-label">💡 Интересный факт:</div>
                        <div class="fact-text" id="fact-text"></div>
                    </div>
                    
                    <div class="grid" id="answers-container">
                        <!-- Ответы будут добавлены через JavaScript -->
                    </div>
                    
                    <div id="result-fact" class="fact-box" style="display: none; background: rgba(16, 185, 129, 0.2); border-color: rgba(16, 185, 129, 0.3);">
                        <div class="fact-label" style="color: #6EE7B7;">💡 Интересный факт:</div>
                        <div class="fact-text" style="color: #D1FAE5;" id="result-fact-text"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Экран результатов -->
        <div id="results-screen" class="screen">
            <div class="container">
                <div class="card text-center">
                    <h1 class="mb-4" style="font-size: 48px; font-weight: 700; background: linear-gradient(45deg, #FBBF24, #F59E0B); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                        🎉 ИГРА ЗАВЕРШЕНА!
                    </h1>
                    <div style="font-size: 72px; font-weight: 700; color: #FBBF24; margin-bottom: 8px;" id="final-score">0</div>
                    <div style="font-size: 24px; color: #D1D5DB; margin-bottom: 32px;">очков</div>

                    <div class="grid grid-2 mb-8">
                        <div style="background: rgba(16, 185, 129, 0.2); border-radius: 12px; padding: 24px;">
                            <div style="font-size: 36px; font-weight: 700; color: #34D399;" id="correct-answers">0/0</div>
                            <div style="color: #6EE7B7;">Правильных ответов</div>
                            <div style="font-size: 24px; font-weight: 700; color: #34D399;" id="accuracy">0%</div>
                        </div>
                        <div style="background: rgba(59, 130, 246, 0.2); border-radius: 12px; padding: 24px;">
                            <div style="font-size: 36px; font-weight: 700; color: #60A5FA;" id="avg-time">0с</div>
                            <div style="color: #93C5FD;">Среднее время</div>
                        </div>
                    </div>

                    <div class="space-y-4">
                        <h3 style="font-size: 24px; font-weight: 600;">Детали ответов</h3>
                        <div id="answers-details" class="question-list" style="max-height: 300px; text-align: left;">
                            <!-- Детали будут добавлены через JavaScript -->
                        </div>
                    </div>

                    <div class="space-y-4 mt-8">
                        <button class="btn btn-success" onclick="restartGame()">🎮 Играть снова</button>
                        <button class="btn btn-warning" onclick="showScreen('leaderboard')">🏆 Лидеры</button>
                        <button class="btn btn-gray" onclick="showScreen('welcome')">🏠 На главную</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Экран лидеров -->
        <div id="leaderboard-screen" class="screen">
            <div class="container">
                <button class="btn btn-gray mb-8" onclick="showScreen('welcome')">← Назад</button>
                
                <div class="card">
                    <h2 class="text-center mb-8" style="font-size: 48px; font-weight: 700; background: linear-gradient(45deg, #FBBF24, #F59E0B); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                        🏆 ТАБЛИЦА ЛИДЕРОВ
                    </h2>
                    
                    <div id="leaderboard-list">
                        <!-- Лидеры будут добавлены через JavaScript -->
                    </div>
                    
                    <div class="text-center mt-8">
                        <button id="clear-leaderboard-btn" class="btn btn-danger">🗑️ Очистить таблицу</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Экран редактора -->
        <div id="editor-screen" class="screen">
            <div class="container">
                <button class="btn btn-gray mb-8" onclick="showScreen('welcome')">← Назад</button>
                
                <div class="card">
                    <h2 class="text-center mb-8" style="font-size: 48px; font-weight: 700;">✏️ РЕДАКТОР ВОПРОСОВ</h2>
                    
                    <!-- Выбор раунда -->
                    <div class="mb-8">
                        <h3 style="font-size: 24px; font-weight: 600; margin-bottom: 16px;">Выберите раунд:</h3>
                        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                            <button class="btn" onclick="selectRound(1)" id="round-1" style="background: #60A5FA;">Раунд 1 (20)</button>
                            <button class="btn" onclick="selectRound(2)" id="round-2" style="background: #6B7280;">Раунд 2 (20)</button>
                            <button class="btn" onclick="selectRound(3)" id="round-3" style="background: #6B7280;">Раунд 3 (0)</button>
                            <button class="btn" onclick="selectRound(4)" id="round-4" style="background: #6B7280;">Раунд 4 (0)</button>
                            <button class="btn" onclick="selectRound(5)" id="round-5" style="background: #6B7280;">Раунд 5 (0)</button>
                        </div>
                    </div>

                    <div class="grid grid-2">
                        <!-- Форма добавления -->
                        <div class="editor-form">
                            <h3 style="font-size: 24px; font-weight: 600; margin-bottom: 16px;">Добавить вопрос</h3>
                            
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-weight: 500; margin-bottom: 8px;">Текст вопроса:</label>
                                <textarea class="textarea" id="new-question-text" placeholder="Введите текст вопроса..."></textarea>
                            </div>

                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-weight: 500; margin-bottom: 8px;">Варианты ответов:</label>
                                <div id="answer-options">
                                    <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                                        <input type="radio" name="correct" value="0" checked>
                                        <input class="input" id="option-0" placeholder="Вариант 1..." style="flex: 1;">
                                    </div>
                                    <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                                        <input type="radio" name="correct" value="1">
                                        <input class="input" id="option-1" placeholder="Вариант 2..." style="flex: 1;">
                                    </div>
                                    <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                                        <input type="radio" name="correct" value="2">
                                        <input class="input" id="option-2" placeholder="Вариант 3..." style="flex: 1;">
                                    </div>
                                    <div style="display: flex; gap: 8px; margin-bottom: 8px;">
                                        <input type="radio" name="correct" value="3">
                                        <input class="input" id="option-3" placeholder="Вариант 4..." style="flex: 1;">
                                    </div>
                                </div>
                            </div>

                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-weight: 500; margin-bottom: 8px;">Интересный факт (опционально):</label>
                                <textarea class="textarea" id="new-question-fact" placeholder="Интересный факт о вопросе..."></textarea>
                            </div>

                            <button class="btn btn-success" onclick="addQuestion()" style="width: 100%;">➕ Добавить вопрос</button>
                        </div>

                        <!-- Список вопросов -->
                        <div>
                            <h3 style="font-size: 24px; font-weight: 600; margin-bottom: 16px;" id="round-title">Раунд 1 — Лёгкий</h3>
                            <div class="question-list" id="questions-list">
                                <!-- Вопросы будут добавлены через JavaScript -->
                            </div>
                        </div>
                    </div>

                    <div class="text-center mt-8">
                        <button class="btn btn-secondary" onclick="saveQuestions()">💾 Сохранить изменения</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Данные вопросов
        const defaultQuestions = {
            1: [
                {
                    текст: "Какое настоящее имя персонажа, известного как Хайзенберг в «Во все тяжкие»?",
                    варианты: ["Хэнк Шрейдер", "Уолтер Уайт", "Джек Уэлкер", "Гейл Беттикер"],
                    правильный: 1,
                    факт: "Хайзенберг — псевдоним Уолтера Уайта, взятый в честь физика Вернера Гейзенберга"
                },
                {
                    текст: "В каком сериале впервые появляется «Железный трон»?",
                    варианты: ["Викинги", "Рим", "Дом дракона", "Игра престолов"],
                    правильный: 3,
                    факт: "Железный трон был выкован из мечей побеждённых врагов Эйгона Завоевателя"
                },
                {
                    текст: "Какой сериал стал культовым портретом жизни итальянской мафии в Нью-Джерси?",
                    варианты: ["Подпольная империя", "Борджиа", "Клан Сопрано", "Гоморра"],
                    правильный: 2,
                    факт: "«Клан Сопрано» считается одним из лучших сериалов всех времён"
                },
                {
                    текст: "В каком городе происходит действие «Очень странные дела»?",
                    варианты: ["Хокинс", "Дарквуд", "Миллфилд", "Блэкридж"],
                    правильный: 0,
                    факт: "Хокинс — вымышленный город в штате Индиана"
                },
                {
                    текст: "Какое настоящее имя у адвоката, которого все знают как Сола Гудмана?",
                    варианты: ["Ховард Хэмлин", "Джимми Макгилл", "Чук Макгилл", "Клифф Мейн"],
                    правильный: 1,
                    факт: "Джимми Макгилл изменил имя на Сол Гудман для привлечения клиентов"
                },
                {
                    текст: "В каком сериале герой просыпается после комы и узнаёт, что мир захвачен зомби?",
                    варианты: ["12 обезьян", "Мгла", "Ходячие мертвецы", "Королевство"],
                    правильный: 2,
                    факт: "Рик Граймс проснулся после комы в больнице и обнаружил апокалипсис"
                },
                {
                    текст: "Какая актриса сыграла гениальную шахматистку Бет Хармон?",
                    варианты: ["Флоренс Пью", "Софи Куксон", "Сидни Суини", "Аня Тейлор-Джой"],
                    правильный: 3,
                    факт: "«Ход королевы» привёл к буму интереса к шахматам по всему миру"
                },
                {
                    текст: "Кто исполнил роль доктора Ватсона в сериале «Шерлок» (BBC)?",
                    варианты: ["Мартин Фриман", "Джеймс Нортон", "Пол Беттани", "Доминик Купер"],
                    правильный: 0,
                    факт: "Мартин Фриман также известен ролью Бильбо Бэггинса в «Хоббите»"
                },
                {
                    текст: "Как зовут брата, ради которого Майкл Скофилд затеял побег?",
                    варианты: ["Джон Абруцци", "Линкольн Барроуз", "Фернандо Сукре", "Теодор Бэгвелл"],
                    правильный: 1,
                    факт: "Майкл сделал татуировку с планом тюрьмы на всём теле"
                },
                {
                    текст: "В каком сериале Том Харди играет Джеймса Делэйни?",
                    варианты: ["Острые козырьки", "Город взаперти", "Табу", "Падение"],
                    правильный: 2,
                    факт: "«Табу» создал сам Том Харди вместе с отцом"
                }
            ],
            2: [
                {
                    текст: "В каком сериале заключённые живут по принципу «оранжевый — хит сезона»?",
                    варианты: ["Побег", "Тюрьма Оз", "Оранжевый — хит сезона", "Заключённые"],
                    правильный: 2,
                    факт: "Сериал основан на мемуарах Пайпер Керман о её времени в тюрьме"
                },
                {
                    текст: "Кто сыграл Сандора Клигана (Пса) в «Игре престолов»?",
                    варианты: ["Рори МакКанн", "Конлет Хилл", "Кристофер Хивью", "Джером Флинн"],
                    правильный: 0,
                    факт: "Рори МакКанн — шотландский актёр ростом 198 см"
                },
                {
                    текст: "Какая страна стала местом действия «Бумажного дома»?",
                    варианты: ["Италия", "Португалия", "Франция", "Испания"],
                    правильный: 3,
                    факт: "Сериал стал самым популярным неанглоязычным шоу на Netflix"
                },
                {
                    текст: "В каком городе происходят «Острые козырьки»?",
                    варианты: ["Ливерпуль", "Бирмингем", "Лидс", "Манчестер"],
                    правильный: 1,
                    факт: "Действие происходит в послевоенном Бирмингеме 1920-х годов"
                },
                {
                    текст: "Как зовут жену Гомера Симпсона?",
                    варианты: ["Пэтти", "Сельма", "Мардж", "Эдна"],
                    правильный: 2,
                    факт: "«Симпсоны» — самый долгоидущий анимационный сериал в истории"
                },
                {
                    текст: "Какая экранизация романа Маргарет Этвуд?",
                    варианты: ["Прислуга", "Колесо времени", "Дочери Анархии", "Рассказ служанки"],
                    правильный: 3,
                    факт: "Роман Этвуд был написан в 1985 году и предсказал многие современные проблемы"
                },
                {
                    текст: "Кто исполнил роль Декстера Моргана?",
                    варианты: ["Майкл С. Холл", "Джон Хэмм", "Питер Краузе", "Дэвид Духовны"],
                    правильный: 0,
                    факт: "Майкл С. Холл также известен ролью Дэвида Фишера в «Клиенте всегда мёртв»"
                },
                {
                    текст: "Как называется сериал о таинственном городке Ривердейл?",
                    варианты: ["Эйфория", "Ривердейл", "Маленькие лгунишки", "Алфавитные убийства"],
                    правильный: 1,
                    факт: "«Ривердейл» основан на комиксах Archie Comics"
                },
                {
                    текст: "Какая команда противостоит «Семёрке»?",
                    варианты: ["Охотники", "Изгои", "Пацаны", "Сторожевые псы"],
                    правильный: 2,
                    факт: "«Пацаны» — сатира на супергеройские фильмы и корпоративную культуру"
                },
                {
                    текст: "Какой сериал посвящён Елизавете II?",
                    варианты: ["Виктория", "Елизавета: золотой век", "Тюдоры", "Корона"],
                    правильный: 3,
                    факт: "«Корона» покрывает период правления с 1940-х по 2000-е годы"
                }
            ],
            3: [],
            4: [],
            5: []
        };

        // Состояние игры
        let gameState = {
            currentRound: 1,
            currentQuestion: 0,
            score: 0,
            answers: [],
            timeLeft: 20,
            hintsUsed: { fiftyFifty: 3, extraTime: 3, fact: 3 },
            hintsAtQuestionStart: { fiftyFifty: 3, extraTime: 3, fact: 3 },
            gameMode: 'single',
            timer: null,
            questionStartTime: 0,
            selectedAnswer: null,
            showResult: false,
            hiddenAnswers: new Set(),
            showFact: false
        };

        // Настройки раундов
        const roundTimeouts = [20, 18, 16, 14, 12];
        const roundMultipliers = [1.0, 1.3, 1.6, 2.0, 2.5];

        // Загрузка данных
        let questions = JSON.parse(localStorage.getItem('tvQuizQuestions')) || defaultQuestions;
        let leaderboard = JSON.parse(localStorage.getItem('tvQuizLeaderboard')) || [];

        // Редактор
        let selectedRound = 1;

        // Функция экранирования HTML для защиты от XSS
        function escapeHTML(s) {
            return String(s).replace(/[&<>"']/g, m => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            }[m]));
        }

        // Функции для расчёта прогресса
        function totalQuestionsAvailable() {
            let t = 0;
            for (let r = 1; r <= 5; r++) {
                t += (questions[r]?.length || 0);
            }
            return t;
        }

        function currentQuestionIndex() {
            let idx = 0;
            for (let r = 1; r < gameState.currentRound; r++) {
                idx += (questions[r]?.length || 0);
            }
            return idx + gameState.currentQuestion + 1;
        }

        // Делаем все основные функции глобальными для onclick-обработчиков
        window.showScreen = showScreen;
        window.startGame = startGame;
        window.selectAnswer = selectAnswer;
        window.useHint = useHint;
        window.restartGame = restartGame;
        window.selectRound = selectRound;
        window.addQuestion = addQuestion;
        window.deleteQuestion = deleteQuestion;
        window.saveQuestions = saveQuestions;

        // Инициализация
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Приложение инициализировано');
            
            // Регистрируем Service Worker для PWA
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('data:application/javascript;base64,' + btoa(`
                    const CACHE_NAME = 'tv-quiz-v1';
                    const urlsToCache = ['./', 'https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap'];
                    
                    self.addEventListener('install', event => {
                        event.waitUntil(caches.open(CACHE_NAME).then(cache => cache.addAll(urlsToCache)));
                    });
                    
                    self.addEventListener('fetch', event => {
                        event.respondWith(
                            caches.match(event.request).then(response => response || fetch(event.request))
                        );
                    });
                `)).then(registration => {
                    console.log('Service Worker зарегистрирован:', registration.scope);
                }).catch(error => {
                    console.log('Ошибка регистрации Service Worker:', error);
                });
            }
            
            // Предложение установить приложение
            let deferredPrompt;
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                showInstallButton();
            });
            
            function showInstallButton() {
                // Создаем кнопку установки
                const installBtn = document.createElement('button');
                installBtn.innerHTML = '📱 Установить приложение';
                installBtn.className = 'btn btn-primary';
                installBtn.style.position = 'fixed';
                installBtn.style.bottom = '20px';
                installBtn.style.right = '20px';
                installBtn.style.zIndex = '1000';
                installBtn.style.fontSize = '14px';
                installBtn.style.padding = '12px 16px';
                
                installBtn.addEventListener('click', () => {
                    if (deferredPrompt) {
                        deferredPrompt.prompt();
                        deferredPrompt.userChoice.then((choiceResult) => {
                            if (choiceResult.outcome === 'accepted') {
                                console.log('Пользователь установил приложение');
                            }
                            deferredPrompt = null;
                            installBtn.remove();
                        });
                    }
                });
                
                document.body.appendChild(installBtn);
                
                // Убираем кнопку через 10 секунд если не нажали
                setTimeout(() => {
                    if (installBtn.parentNode) {
                        installBtn.remove();
                    }
                }, 10000);
            }
            
            showScreen('welcome');
            
            // Привязываем обработчик для кнопки очистки лидеров
            const clearBtn = document.getElementById('clear-leaderboard-btn');
            if (clearBtn) {
                clearBtn.addEventListener('click', function() {
                    console.log('Кнопка очистки нажата');
                    if (confirm('Вы уверены, что хотите очистить таблицу лидеров?')) {
                        console.log('Пользователь подтвердил очистку');
                        leaderboard = [];
                        localStorage.removeItem('tvQuizLeaderboard');
                        updateLeaderboard();
                        alert('Таблица лидеров очищена!');
                        console.log('Таблица лидеров очищена');
                    } else {
                        console.log('Пользователь отменил очистку');
                    }
                });
                console.log('Обработчик кнопки очистки привязан');
            } else {
                console.error('Кнопка очистки лидеров не найдена');
            }
            
            // Загружаем сохранённые данные
            const savedLeaderboard = localStorage.getItem('tvQuizLeaderboard');
            if (savedLeaderboard) {
                try {
                    leaderboard = JSON.parse(savedLeaderboard);
                    console.log('Загружена таблица лидеров:', leaderboard.length, 'записей');
                } catch (e) {
                    console.error('Ошибка загрузки таблицы лидеров:', e);
                    leaderboard = [];
                }
            }
            
            const savedQuestions = localStorage.getItem('tvQuizQuestions');
            if (savedQuestions) {
                try {
                    questions = JSON.parse(savedQuestions);
                    console.log('Загружены пользовательские вопросы');
                } catch (e) {
                    console.error('Ошибка загрузки вопросов:', e);
                    questions = defaultQuestions;
                }
            }
            
            updateRoundButtons();
        });

        // Показать экран
        function showScreen(screenName) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenName + '-screen').classList.add('active');
            
            // Обновляем данные при показе определенных экранов
            if (screenName === 'leaderboard') {
                updateLeaderboard();
            } else if (screenName === 'editor') {
                updateRoundButtons();
                updateQuestionsList();
                updateRoundTitle();
            }
        }

        // Начать игру
        function startGame(mode) {
            // Проверяем, есть ли вообще вопросы
            if (totalQuestionsAvailable() === 0) {
                alert('Нет доступных вопросов! Добавьте вопросы в редакторе.');
                return;
            }
            
            // Найти первый раунд с вопросами
            let firstRound = 1;
            while (firstRound <= 5 && (!questions[firstRound] || questions[firstRound].length === 0)) {
                firstRound++;
            }
            
            if (firstRound > 5) {
                alert('Нет доступных вопросов! Добавьте вопросы в редакторе.');
                return;
            }
            
            gameState = {
                currentRound: firstRound,
                currentQuestion: 0,
                score: 0,
                answers: [],
                timeLeft: 20,
                hintsUsed: { fiftyFifty: 3, extraTime: 3, fact: 3 },
                hintsAtQuestionStart: { fiftyFifty: 3, extraTime: 3, fact: 3 },
                gameMode: mode,
                timer: null,
                questionStartTime: 0,
                selectedAnswer: null,
                showResult: false,
                hiddenAnswers: new Set(),
                showFact: false
            };
            
            showScreen('game');
            loadQuestion();
        }

        // Загрузить вопрос
        function loadQuestion() {
            const currentQuestions = questions[gameState.currentRound] || [];
            const currentQuestion = currentQuestions[gameState.currentQuestion];
            
            if (!currentQuestion) {
                alert('Вопросы не найдены для этого раунда!');
                showScreen('welcome');
                return;
            }

            // Сброс состояния
            gameState.selectedAnswer = null;
            gameState.showResult = false;
            gameState.hiddenAnswers = new Set();
            gameState.showFact = false;
            gameState.timeLeft = roundTimeouts[gameState.currentRound - 1];
            gameState.questionStartTime = Date.now();

            // Обновление интерфейса
            updateGameUI();
            
            // Сохранить состояние подсказок в начале вопроса
            gameState.hintsAtQuestionStart = {...gameState.hintsUsed};
            
            // Показать вопрос
            document.getElementById('question-text').textContent = currentQuestion.текст;
            
            // Создать кнопки ответов
            const container = document.getElementById('answers-container');
            container.innerHTML = '';
            
            currentQuestion.варианты.forEach((variant, index) => {
                const button = document.createElement('button');
                button.className = 'answer-btn';
                button.innerHTML = `<span style="color: #60A5FA; font-weight: 700; margin-right: 12px;">${String.fromCharCode(65 + index)}.</span>${escapeHTML(variant)}`;
                button.onclick = () => selectAnswer(index);
                button.id = `answer-${index}`;
                button.disabled = false; // Явно включаем кнопку
                container.appendChild(button);
            });

            // Скрыть факты
            document.getElementById('fact-box').style.display = 'none';
            document.getElementById('result-fact').style.display = 'none';

            // Запустить таймер
            startTimer();
        }

        // Запустить таймер
        function startTimer() {
            if (gameState.timer) {
                clearInterval(gameState.timer);
            }
            
            gameState.timer = setInterval(() => {
                gameState.timeLeft--;
                updateTimerDisplay();
                
                if (gameState.timeLeft <= 0) {
                    clearInterval(gameState.timer);
                    selectAnswer(-1); // Время вышло
                }
            }, 1000);
        }

        // Обновить отображение таймера
        function updateTimerDisplay() {
            const timerDisplay = document.getElementById('timer-display');
            timerDisplay.textContent = gameState.timeLeft + 'с';
            
            if (gameState.timeLeft <= 5) {
                timerDisplay.classList.add('warning');
            } else {
                timerDisplay.classList.remove('warning');
            }
        }

        // Выбрать ответ
        function selectAnswer(answerIndex) {
            if (gameState.showResult) return;
            
            clearInterval(gameState.timer);
            gameState.selectedAnswer = answerIndex;
            gameState.showResult = true;
            
            const currentQuestions = questions[gameState.currentRound] || [];
            const currentQuestion = currentQuestions[gameState.currentQuestion];
            const isCorrect = answerIndex === currentQuestion.правильный;
            
            // Подсветить ответы
            document.querySelectorAll('.answer-btn').forEach((btn, index) => {
                btn.disabled = true; // Отключаем все кнопки
                
                if (index === currentQuestion.правильный) {
                    btn.classList.add('correct');
                } else if (index === answerIndex && !isCorrect) {
                    btn.classList.add('incorrect');
                } else {
                    // Обычные неправильные ответы становятся серыми
                    btn.style.opacity = '0.6';
                }
            });

            // Подсчёт очков
            const timeSpent = (Date.now() - gameState.questionStartTime) / 1000;
            const speedMultiplier = Math.max(0.5, 2 - (timeSpent / roundTimeouts[gameState.currentRound - 1]));
            const roundMultiplier = roundMultipliers[gameState.currentRound - 1];
            
            let points = 0;
            if (isCorrect) {
                points = Math.round(100 * speedMultiplier * roundMultiplier);
                // Штраф за подсказки
                const hintsUsedCount = (3 - gameState.hintsUsed.fiftyFifty) + 
                                     (3 - gameState.hintsUsed.extraTime) + 
                                     (3 - gameState.hintsUsed.fact);
                if (hintsUsedCount > 0) {
                    points = Math.round(points * 0.8);
                }
            }
            
            // Сохранить ответ
            const answer = {
                question: currentQuestion.текст,
                selectedAnswer: answerIndex >= 0 ? currentQuestion.варианты[answerIndex] : "Время вышло",
                correctAnswer: currentQuestion.варианты[currentQuestion.правильный],
                isCorrect,
                points,
                timeSpent
            };
            
            gameState.answers.push(answer);
            gameState.score += points;
            
            // Показать факт в результате только если его не показывали через подсказку
            if (currentQuestion.факт && !gameState.showFact) {
                document.getElementById('result-fact-text').textContent = currentQuestion.факт;
                document.getElementById('result-fact').style.display = 'block';
            }
            
            updateGameUI();
            
            // Переход к следующему вопросу
            setTimeout(() => {
                nextQuestion();
            }, 3000);
        }

        // Следующий вопрос
        function nextQuestion() {
            const currentRoundQuestions = questions[gameState.currentRound] || [];
            
            if (gameState.currentQuestion < currentRoundQuestions.length - 1) {
                // Есть ещё вопросы в текущем раунде
                gameState.currentQuestion++;
                loadQuestion();
            } else {
                // Ищем следующий раунд с вопросами
                let nextRound = gameState.currentRound + 1;
                while (nextRound <= 5 && (!questions[nextRound] || questions[nextRound].length === 0)) {
                    nextRound++;
                }
                
                if (nextRound <= 5) {
                    // Найден раунд с вопросами
                    gameState.currentRound = nextRound;
                    gameState.currentQuestion = 0;
                    loadQuestion();
                } else {
                    // Больше нет вопросов - конец игры
                    endGame();
                }
            }
        }

        // Завершить игру
        function endGame() {
            clearInterval(gameState.timer);
            
            const correctAnswers = gameState.answers.filter(a => a.isCorrect).length;
            const totalTime = gameState.answers.reduce((sum, a) => sum + a.timeSpent, 0);
            const avgTime = totalTime / gameState.answers.length;
            
            const result = {
                score: gameState.score,
                accuracy: Math.round((correctAnswers / gameState.answers.length) * 100),
                avgTime: Math.round(avgTime * 10) / 10,
                date: new Date().toLocaleDateString('ru-RU'),
                answers: gameState.answers
            };
            
            // Добавить в таблицу лидеров
            leaderboard.push(result);
            leaderboard.sort((a, b) => b.score - a.score);
            leaderboard = leaderboard.slice(0, 10);
            localStorage.setItem('tvQuizLeaderboard', JSON.stringify(leaderboard));
            
            showResults();
        }

        // Показать результаты
        function showResults() {
            const correctAnswers = gameState.answers.filter(a => a.isCorrect).length;
            const totalQuestions = gameState.answers.length;
            const accuracy = Math.round((correctAnswers / totalQuestions) * 100);
            const totalTime = gameState.answers.reduce((sum, a) => sum + a.timeSpent, 0);
            const avgTime = Math.round(totalTime * 10) / 10;

            document.getElementById('final-score').textContent = gameState.score.toLocaleString();
            document.getElementById('correct-answers').textContent = `${correctAnswers}/${totalQuestions}`;
            document.getElementById('accuracy').textContent = `${accuracy}%`;
            document.getElementById('avg-time').textContent = `${avgTime}с`;

            // Детали ответов
            const container = document.getElementById('answers-details');
            container.innerHTML = '';
            
            gameState.answers.forEach((answer, index) => {
                const div = document.createElement('div');
                div.className = 'question-item';
                div.style.background = answer.isCorrect ? 'rgba(16, 185, 129, 0.2)' : 'rgba(239, 68, 68, 0.2)';
                
                div.innerHTML = `
                    <div style="font-weight: 600; margin-bottom: 8px;">${escapeHTML(answer.question)}</div>
                    <div style="color: #D1D5DB; font-size: 14px; margin-bottom: 4px;">
                        Ваш ответ: ${escapeHTML(String(answer.selectedAnswer))}
                        ${!answer.isCorrect ? ` | Правильный: ${escapeHTML(String(answer.correctAnswer))}` : ''}
                    </div>
                    <div style="color: #9CA3AF; font-size: 12px;">
                        Время: ${answer.timeSpent.toFixed(1)}с | Очки: ${answer.points}
                    </div>
                `;
                
                container.appendChild(div);
            });

            showScreen('results');
        }

        // Перезапустить игру
        function restartGame() {
            // Найти первый раунд с вопросами
            let firstRound = 1;
            while (firstRound <= 5 && (!questions[firstRound] || questions[firstRound].length === 0)) {
                firstRound++;
            }
            
            if (firstRound > 5) {
                alert('Нет доступных вопросов! Добавьте вопросы в редакторе.');
                showScreen('welcome');
                return;
            }
            
            gameState = {
                currentRound: firstRound,
                currentQuestion: 0,
                score: 0,
                answers: [],
                timeLeft: 20,
                hintsUsed: { fiftyFifty: 3, extraTime: 3, fact: 3 },
                hintsAtQuestionStart: { fiftyFifty: 3, extraTime: 3, fact: 3 },
                gameMode: gameState.gameMode,
                timer: null,
                questionStartTime: 0,
                selectedAnswer: null,
                showResult: false,
                hiddenAnswers: new Set(),
                showFact: false
            };
            
            showScreen('game');
            loadQuestion();
        }

        // Обновить интерфейс игры
        function updateGameUI() {
            document.getElementById('round-display').textContent = `${gameState.currentRound}/5`;
            document.getElementById('question-display').textContent = `${gameState.currentQuestion + 1}/${questions[gameState.currentRound]?.length || 0}`;
            document.getElementById('score-display').textContent = gameState.score.toLocaleString();
            
            // Динамический расчёт прогресса
            const total = totalQuestionsAvailable();
            const pct = total > 0 ? Math.min(100, Math.round(currentQuestionIndex() / total * 100)) : 0;
            document.getElementById('progress-fill').style.width = pct + '%';
            
            // Обновить подсказки
            document.getElementById('fifty-count').textContent = gameState.hintsUsed.fiftyFifty;
            document.getElementById('time-count').textContent = gameState.hintsUsed.extraTime;
            document.getElementById('fact-count').textContent = gameState.hintsUsed.fact;
            
            // Правильно устанавливаем состояние кнопок подсказок
            const fiftyBtn = document.getElementById('hint-fifty');
            const timeBtn = document.getElementById('hint-time');
            const factBtn = document.getElementById('hint-fact');
            
            fiftyBtn.disabled = gameState.hintsUsed.fiftyFifty <= 0 || gameState.showResult;
            timeBtn.disabled = gameState.hintsUsed.extraTime <= 0 || gameState.showResult;
            factBtn.disabled = gameState.hintsUsed.fact <= 0 || gameState.showResult;
            
            // Обновляем стили для визуальной обратной связи
            if (fiftyBtn.disabled) {
                fiftyBtn.style.opacity = '0.5';
                fiftyBtn.style.cursor = 'not-allowed';
            } else {
                fiftyBtn.style.opacity = '1';
                fiftyBtn.style.cursor = 'pointer';
            }
            
            if (timeBtn.disabled) {
                timeBtn.style.opacity = '0.5';
                timeBtn.style.cursor = 'not-allowed';
            } else {
                timeBtn.style.opacity = '1';
                timeBtn.style.cursor = 'pointer';
            }
            
            if (factBtn.disabled) {
                factBtn.style.opacity = '0.5';
                factBtn.style.cursor = 'not-allowed';
            } else {
                factBtn.style.opacity = '1';
                factBtn.style.cursor = 'pointer';
            }
            
            updateTimerDisplay();
        }

        // Использовать подсказку
        function useHint(hintType) {
            if (gameState.hintsUsed[hintType] <= 0 || gameState.showResult) return;
            
            gameState.hintsUsed[hintType]--;
            
            const currentQuestions = questions[gameState.currentRound] || [];
            const currentQuestion = currentQuestions[gameState.currentQuestion];
            
            switch (hintType) {
                case 'fiftyFifty': {
                    const correct = currentQuestion.правильный;
                    const pool = [0, 1, 2, 3].filter(i => i !== correct && !gameState.hiddenAnswers.has(i));
                    
                    // Проверяем, что есть варианты для скрытия
                    if (pool.length < 2) {
                        console.warn('Недостаточно вариантов для подсказки 50/50');
                        return;
                    }
                    
                    // Перемешать массив (алгоритм Фишера-Йейтса) и взять 2
                    for (let i = pool.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [pool[i], pool[j]] = [pool[j], pool[i]];
                    }
                    const toHide = pool.slice(0, 2);
                    toHide.forEach(i => {
                        const btn = document.getElementById(`answer-${i}`);
                        if (btn) {
                            btn.classList.add('hidden');
                            btn.disabled = true;
                            btn.style.opacity = '0.3';
                            btn.style.cursor = 'not-allowed';
                            gameState.hiddenAnswers.add(i);
                        }
                    });
                    break;
                }
                    
                case 'extraTime':
                    gameState.timeLeft += 5;
                    break;
                    
                case 'fact':
                    if (currentQuestion.факт) {
                        gameState.showFact = true;
                        document.getElementById('fact-text').textContent = currentQuestion.факт;
                        document.getElementById('fact-box').style.display = 'block';
                    }
                    break;
            }
            
            updateGameUI();
        }

        // Таблица лидеров
        function updateLeaderboard() {
            const container = document.getElementById('leaderboard-list');
            if (!container) {
                console.error('Контейнер leaderboard-list не найден');
                return;
            }
            
            container.innerHTML = '';
            
            if (leaderboard.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #9CA3AF; padding: 48px 0;">
                        <div style="font-size: 64px; margin-bottom: 16px;">🏁</div>
                        <div style="font-size: 24px;">Пока никто не играл</div>
                        <div style="color: #6B7280;">Будьте первым!</div>
                    </div>
                `;
                return;
            }
            
            leaderboard.forEach((result, index) => {
                const div = document.createElement('div');
                div.className = 'leaderboard-item';
                
                if (index === 0) div.classList.add('gold');
                else if (index === 1) div.classList.add('silver');
                else if (index === 2) div.classList.add('bronze');
                
                const emoji = index === 0 ? '🥇' : index === 1 ? '🥈' : index === 2 ? '🥉' : `${index + 1}.`;
                
                div.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div style="font-size: 32px; font-weight: 700; width: 60px; text-align: center;">${emoji}</div>
                        <div>
                            <div style="font-weight: 700; font-size: 24px;">${result.score.toLocaleString()} очков</div>
                            <div style="color: #D1D5DB; font-size: 14px;">
                                Точность: ${result.accuracy}% | Ср. время: ${result.avgTime}с
                            </div>
                            <div style="color: #9CA3AF; font-size: 12px;">${result.date}</div>
                        </div>
                    </div>
                `;
                
                container.appendChild(div);
            });
        }

        // Глобальная функция для очистки лидеров
        window.clearLeaderboard = function() {
            console.log('Функция clearLeaderboard вызвана');
            if (confirm('Вы уверены, что хотите очистить таблицу лидеров?')) {
                console.log('Пользователь подтвердил очистку');
                leaderboard = [];
                localStorage.removeItem('tvQuizLeaderboard');
                updateLeaderboard();
                alert('Таблица лидеров очищена!');
                console.log('Таблица лидеров очищена');
            } else {
                console.log('Пользователь отменил очистку');
            }
        };

        // Редактор вопросов
        function selectRound(round) {
            selectedRound = round;
            updateRoundButtons();
            updateQuestionsList();
            updateRoundTitle();
        }

        function updateRoundButtons() {
            for (let i = 1; i <= 5; i++) {
                const btn = document.getElementById(`round-${i}`);
                const count = questions[i] ? questions[i].length : 0;
                btn.textContent = `Раунд ${i} (${count})`;
                
                if (i === selectedRound) {
                    btn.style.background = '#60A5FA';
                } else {
                    btn.style.background = '#6B7280';
                }
            }
        }

        function updateRoundTitle() {
            const titles = {
                1: 'Раунд 1 — Лёгкий',
                2: 'Раунд 2 — Средний', 
                3: 'Раунд 3 — Повышенный',
                4: 'Раунд 4 — Сложный',
                5: 'Раунд 5 — Экспертный'
            };
            document.getElementById('round-title').textContent = titles[selectedRound];
        }

        function updateQuestionsList() {
            const container = document.getElementById('questions-list');
            container.innerHTML = '';
            
            const roundQuestions = questions[selectedRound] || [];
            
            if (roundQuestions.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: #9CA3AF; padding: 32px 0;">Вопросов пока нет</div>';
                return;
            }
            
            roundQuestions.forEach((question, index) => {
                const div = document.createElement('div');
                div.className = 'question-item';
                
                div.innerHTML = `
                    <div style="font-weight: 600; margin-bottom: 8px;">${escapeHTML(question.текст)}</div>
                    <div style="color: #D1D5DB; font-size: 14px; margin-bottom: 8px;">
                        ${question.варианты.map((variant, vIndex) => 
                            `<div style="${vIndex === question.правильный ? 'color: #34D399; font-weight: 600;' : ''}">${String.fromCharCode(65 + vIndex)}. ${escapeHTML(variant)}</div>`
                        ).join('')}
                    </div>
                    ${question.факт ? `<div style="color: #93C5FD; font-size: 12px; margin-bottom: 8px;">💡 ${escapeHTML(question.факт)}</div>` : ''}
                    <button class="btn btn-danger" onclick="deleteQuestion(${index})" style="padding: 4px 12px; font-size: 12px;">🗑️ Удалить</button>
                `;
                
                container.appendChild(div);
            });
        }

        function addQuestion() {
            const text = document.getElementById('new-question-text').value.trim();
            const options = [
                document.getElementById('option-0').value.trim(),
                document.getElementById('option-1').value.trim(),
                document.getElementById('option-2').value.trim(),
                document.getElementById('option-3').value.trim()
            ];
            const fact = document.getElementById('new-question-fact').value.trim();
            const correct = parseInt(document.querySelector('input[name="correct"]:checked').value);
            
            if (!text || options.some(opt => !opt)) {
                alert('Заполните все поля!');
                return;
            }
            
            const newQuestion = {
                текст: text,
                варианты: options,
                правильный: correct,
                факт: fact || undefined
            };
            
            if (!questions[selectedRound]) {
                questions[selectedRound] = [];
            }
            
            questions[selectedRound].push(newQuestion);
            
            // Очистить форму
            document.getElementById('new-question-text').value = '';
            document.getElementById('option-0').value = '';
            document.getElementById('option-1').value = '';
            document.getElementById('option-2').value = '';
            document.getElementById('option-3').value = '';
            document.getElementById('new-question-fact').value = '';
            document.querySelector('input[name="correct"][value="0"]').checked = true;
            
            updateRoundButtons();
            updateQuestionsList();
        }

        function deleteQuestion(index) {
            if (confirm('Вы уверены, что хотите удалить этот вопрос?')) {
                questions[selectedRound].splice(index, 1);
                updateRoundButtons();
                updateQuestionsList();
            }
        }

        function saveQuestions() {
            localStorage.setItem('tvQuizQuestions', JSON.stringify(questions));
            alert('Вопросы сохранены!');
        }
    </script>
</body>
</html>